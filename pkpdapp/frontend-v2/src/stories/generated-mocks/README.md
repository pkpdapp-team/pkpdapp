# Auto-Generated Storybook Mocks

This directory contains automatically generated TypeScript mock files for use in Storybook tests.

## Generation

These files are generated by the Django management command:

```bash
cd pkpdapp
DEBUG=1 python manage.py generate_storybook_mocks
```

## Options

- `--output-dir <path>` - Specify output directory (default: `frontend-v2/src/stories/generated-mocks`)
- `--clean` - Clean database before generating (deletes all test data)
- `--dry-run` - Preview what would be generated without writing files

## Generated Test Data

The command creates:
- A test user (`storybook_test_user`)
- A test compound (small molecule, 500 g/mol)
- A test project (Rat species, 0.25 kg)
- A combined model with:
  - 1-compartmental PK model
  - Direct effect (inhibitory) PD model
  - PK-PD mapping (C1 â†’ C_Drug)
- A protocol with a single IV dose (100 mg at t=0)

## Generated Files

- `project.mock.ts` - Project, compound, and user mocks
- `model.mock.ts` - Combined model, PK models, PD models, and tags
- `protocol.mock.ts` - Protocol and dose mocks
- `units.mock.ts` - Unit system mocks
- `variables.mock.ts` - Variable mocks
- `index.ts` - Exports all mocks

## Usage

Import the mocks and handlers in your Storybook files:

```typescript
import { project, compound, projectHandlers } from "./generated-mocks";
import { pkModels, pdModels, modelHandlers } from "./generated-mocks";

export default {
  title: "My Component",
  component: MyComponent,
  parameters: {
    msw: {
      handlers: {
        project: projectHandlers,
        model: modelHandlers,
      },
    },
  },
};
```

## Ensuring Mocks are Generated

### For Local Development

```bash
# From pkpdapp directory
./scripts/generate-mocks.sh

# Or from frontend-v2 directory (if package.json is configured)
yarn generate-mocks
```

### Before Running Tests

The mocks should be generated before running Storybook tests. You have several options:

**Option 1: Add pre-test hook** (Recommended)
Add to `frontend-v2/package.json`:
```json
{
  "scripts": {
    "pretest": "node scripts/ensure-mocks.js",
    "generate-mocks": "cd ../pkpdapp && ./scripts/generate-mocks.sh"
  }
}
```

**Option 2: Manual generation**
```bash
cd pkpdapp
DEBUG=1 python manage.py generate_storybook_mocks
```

**Option 3: Combined command**
```json
{
  "scripts": {
    "test:with-mocks": "yarn generate-mocks && yarn test"
  }
}
```

### In CI/CD

Add a step to your CI pipeline before frontend tests:

```yaml
# GitHub Actions example
- name: Generate Storybook Mocks
  run: |
    cd pkpdapp
    DEBUG=1 python manage.py migrate
    DEBUG=1 python manage.py generate_storybook_mocks

- name: Run Frontend Tests
  run: |
    cd frontend-v2
    yarn test
```

See [PACKAGE_JSON_UPDATES.md](../../PACKAGE_JSON_UPDATES.md) for detailed integration instructions.

## Important Notes

- **DO NOT EDIT THESE FILES MANUALLY** - They are auto-generated and will be overwritten
- If you need custom test data, either:
  1. Create a separate mock file, or
  2. Modify the Django management command to generate different data
- The generated data is based on a fresh database with only the library models loaded
- **DO NOT COMMIT** the generated `.mock.ts` files to git (they're in `.gitignore`)
